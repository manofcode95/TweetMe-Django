{%load static%}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>{%block title%}Tweet.co {%endblock%}</title>
    <link rel="stylesheet" href="{%static 'css/bootstrap.min.css'%}">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU"
        crossorigin="anonymous">
    <link rel="stylesheet" href="{%static 'css/style.css'%}">

    <!-- fetch tweet -->
    <script>
        // this functions helps you get the search query q
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        function loadTweetContainer(tweetContainerId) {
            var query = getParameterByName('q');
            var tweetList = [];
            var createApiTweet = "/api/tweet/create/";
            var tweetContainer;
            if (tweetContainerId) {
                tweetContainer = $("#" + tweetContainerId)
            } else {
                tweetContainer = $("#tweet-container")
            }
            var initialUrl = tweetContainer.attr("data-url") || "/api/tweet/";
            function updateHashLinks() {
                $(".media-body").each(function (data) {
                    // #hashtag
                    var hashtagRegex = /#([\d\w-]+)/g
                    var newText = $(this).html().replace(hashtagRegex, "<a href='/tags/$1/'>#$1</a>")
                    $(this).html(newText)

                    // @user
                    var userRegex = /@([\d\w-]+)/g
                    var newText = $(this).html().replace(userRegex, "<a href='/tags/$1/'>@$1</a>")
                    $(this).html(newText)
                })
            }

            $(document.body).on("click", ".retweet", function (event) {
                event.preventDefault()
                var url = $(this).attr("href")

                $.ajax({
                    url: url,
                    method: "GET",
                    success: function (data) {
                        if (initialUrl == '/api/tweet/') {
                            console.log(url)
                            attachTweet(data, true, true)
                            updateHashLinks()
                        }
                    },
                    error: function (data) {
                        console.log('bad')
                    }
                })
            })

            // Like toggle
            $(document.body).on("click", ".like-btn", function (event) {
                event.preventDefault()
                var this_ = $(this)
                var tweetId = this_.attr('data-id')
                var likeUrl = '/api/tweet/' + tweetId + '/like'
                console.log(likeUrl)

                $.ajax({
                    url: likeUrl,
                    method: "GET",
                    success: function (data) {
                        console.log('it works')
                        if (data.liked) {
                            this_.text("Liked");
                            console.log('1')
                        } else {
                            this_.text("Unliked");
                            console.log('2')
                        }
                    },
                    error: function (data) {
                        console.log('it doesnt work')
                    }
                })
            })
            function attachTweet(tweetValue, prepend, retweet) {
                var tweetAuthor = tweetValue.author.username;
                var tweetContent = tweetValue.content;
                var tweetDate = tweetValue.time_display;
                var tweetAuthorUrl = tweetValue.author_url;
                var tweetDetailUrl = tweetValue.content_url;
                var retweetUrl = tweetValue.retweet_url
                var tweetHTML;
                if (retweet) {
                    var mainTweet = tweetValue.parent;
                    tweetHTML = '<div class="row mt-3"><div class= "col-sm-3" ><p class="mb-0 text-center"><a href="' + tweetAuthorUrl + '">' + tweetAuthor + '</a></p><p class="text-center">' + tweetDate + '</p></div><div class="col-sm-9"><div class="media"><div class="media-body"><p class="mb-0 gray-text font-italic ">Retweet via <a href="' + mainTweet.author_url + '">' + mainTweet.author.username + '</a></p><p>' + tweetContent + ' (<a href="' + tweetDetailUrl + '">View</a> | <a class="retweet" href="' + mainTweet.retweet_url + '">Retweet</a> | <a class="like-btn" data-id="' + tweetValue.pk + '" href="#">Like</a>)</p></p></div> </div><hr></div></div >'
                } else {
                    tweetHTML = '<div class="row mt-3"><div class= "col-sm-3" ><p class="mb-0 text-center"><a href="' + tweetAuthorUrl + '">' + tweetAuthor + '</a></p><p class="text-center">' + tweetDate + '</p></div><div class="col-sm-9"><div class="media"><div class="media-body"><p class="mb-0 ">' + tweetContent + '(<a href="' + tweetDetailUrl + '">View</a> | <a class="retweet" href="' + retweetUrl + '">Retweet</a>)</p></p></div> </div><hr></div></div >'
                }

                if (prepend == true) {
                    tweetContainer.prepend(tweetHTML)
                } else {
                    tweetContainer.append(tweetHTML)
                }
            }

            function parseTweets() {
                if (tweetList == 0) {
                    tweetContainer.text('No tweets currently found.')
                } else {
                    $.each(tweetList, function (key, value) {
                        if (value.parent) {
                            attachTweet(value, false, true)
                        } else {
                            attachTweet(value, false, false)
                        }
                    })
                }
            }

            var nextTweetUrl;
            function fetchTweet(url) {
                var fetchUrl;
                if (!url) {
                    fetchUrl = initialUrl
                } else {
                    fetchUrl = url
                }
                $.ajax({
                    url: fetchUrl,
                    data: { "q": query },
                    method: "GET",

                    success: function (data) {
                        tweetList = data.results
                        if (data.next) { nextTweetUrl = data.next } else { $("#loadmore").css('display', 'none') }
                        parseTweets()
                        updateHashLinks()
                    },
                    error: function (data) {
                        console.log('error')
                    },
                });
            }
            fetchTweet()

            // load more tweet, go to next api page
            $("#loadmore").click(function (event) {
                event.preventDefault()
                if (nextTweetUrl) { fetchTweet(nextTweetUrl) }
            })

            // count characters of form
            var charsStart = 150
            var charsCurrent = 0
            $("#form_id").append("<span id='tweetCharLeft'>" + charsStart + "</span>")

            // count characters of form, change text colors.
            $("#form_id textarea").keyup(function (event) {
                charsCurrent = charsStart - $(this).val().length
                var charTag = $("#tweetCharLeft")
                charTag.text(charsCurrent)
                if (charsCurrent > 0) {
                    charTag.addClass('green-text')
                } else if (charsCurrent == 0) {
                    charTag.removeClass('green-text')
                } else if (charsCurrent < 0) {
                    charTag.addClass('red-text')
                }

            })


            // count characters of form, show number
            $("#form_id").submit(function (event) {
                event.preventDefault()
                var this_ = $(this)
                var formData = this_.serialize()
                if (charsCurrent >= 0) {
                    $.ajax({
                        url: createApiTweet,
                        data: formData,
                        method: "POST",

                        success: function (data) {
                            this_.find("textarea").val("")
                            attachTweet(data, true)
                            updateHashLinks()
                        },
                        error: function (data) {
                            console.log("error")
                        }
                    })
                } else {
                    console.log('Cannot send')
                }
            })
        }
    </script>
</head>

<body>
    {%block content%} {%endblock%}



    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src='{%static "js/bootstrap.js"%}'> </script>
    {%block script%}{%endblock script%}
    <script>
        $(document).ready(function () {
            var typingTimer;
            var doneInterval = 1500;
            var searchInput = $("#navbar-search-form input[type=search]");
            var searchQuery;

            searchInput.keyup(function (event) {
                searchQuery = $(this).val()
                typingTimer = setTimeout(doneSearchTyping, doneInterval)

            })


            function doneSearchTyping() {
                if (searchQuery) {
                    var url = '/tweet/list/?q=' + searchQuery
                    document.location.href = url;
                }
            }
        })


    </script>
</body>

</html>